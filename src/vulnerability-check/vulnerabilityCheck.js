import { fetchVulnerabilities } from '../vulnerabilityProvider.js';
import { isVulnerable } from './versionCheck.js';

export const getVulnerablePackages = async (parsedFileContent, ecosystem) => {
  let vulnerabilities = [];
  for (const packageName of Object.keys(parsedFileContent)) {
    const packageVersion = parsedFileContent[packageName];
    const parsedVulnerabilities = await fetchVulnerabilities(ecosystem, packageName);

    if (parsedVulnerabilities && parsedVulnerabilities.length > 0) {
        for (const vulnerability of parsedVulnerabilities) {
            if (isVulnerable(packageVersion, vulnerability)) { 
                vulnerabilities.push({ ...vulnerability, version: packageVersion });
            }
        }
    }
  }
  return vulnerabilities;
};
