import axios from 'axios';
const GITHUB_GRAPHQL_URL = 'https://api.github.com/graphql';

const getQuery = (ecosystem, packageName) => `
  query {
    securityVulnerabilities(ecosystem: ${ecosystem.toUpperCase()}, first: 100, package: "${packageName}") {
      nodes {
        severity
        advisory {
          summary
        }
        package {
          name
          ecosystem
        }
        vulnerableVersionRange
        firstPatchedVersion {
          identifier
        }
      }
    }
  }
`;

export const getGithubQuery = (ecosystem, packageName) => getQuery(ecosystem, packageName);

export const callGithubApi = async (query) => {
    try {
      const response = await axios.post(
        GITHUB_GRAPHQL_URL,
        { query: query },
        { headers: { Authorization: `Bearer ${process.env.GITHUB_ACCESS_TOKEN}` } }
      );
      return response.data.data.securityVulnerabilities.nodes;
    } catch (error) {
        console.error(`Error fetching vulnerabilities for ${packageName}:`, error);
        return null;
    }
};